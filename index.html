<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 4px solid #444; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    // Configuration stored outside so we can reboot the game easily
    const gameConfig = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let game = new Phaser.Game(gameConfig);
    let player, skulls, pucks, cursors, scoreText, safeZone;
    let score = 0;
    let isDead = false;

    function preload() {
        // Create Textures
        let z = this.textures.createCanvas('zamboni', 40, 30);
        z.context.fillStyle = '#ff0000'; z.context.fillRect(0, 0, 40, 30);
        z.refresh();

        let s = this.textures.createCanvas('skull', 32, 32);
        s.context.fillStyle = '#ffffff'; s.context.fillRect(0, 0, 32, 32);
        s.refresh();
    }

    function create() {
        isDead = false;
        score = 0;
        
        // Rink Decoration
        this.add.circle(400, 300, 80).setStrokeStyle(2, 0xffffff, 0.2);
        
        // Safe Zone
        safeZone = this.add.rectangle(400, 300, 150, 150, 0x00ffff, 0.1);
        this.physics.add.existing(safeZone, true);

        // Player & Enemies
        player = this.physics.add.sprite(400, 450, 'zamboni');
        skulls = this.physics.add.group();
        skulls.create(400, 100, 'skull').setScale(1.5);

        pucks = this.physics.add.group();
        for(let i=0; i<10; i++) {
            pucks.add(this.add.circle(Phaser.Math.Between(50, 750), Phaser.Math.Between(50, 550), 6, 0xffffff));
        }

        scoreText = this.add.text(20, 20, 'SCORE: 0', { fontSize: '24px', fill: '#00ffff' });

        // Logic
        this.physics.add.overlap(player, pucks, (p, puck) => {
            puck.destroy();
            score += 10;
            scoreText.setText('SCORE: ' + score);
        });

        this.physics.add.overlap(player, skulls, die, null, this);
        this.physics.add.collider(skulls, safeZone);
        
        cursors = this.input.keyboard.createCursorKeys();
    }

    function die() {
        if (isDead) return;
        isDead = true;
        this.physics.pause();
        
        this.add.rectangle(400, 300, 800, 600, 0x000000, 0.8);
        this.add.text(400, 300, 'CRASHED!\nPRESS ANY KEY TO REFRESH', { 
            fontSize: '40px', fill: '#f00', align: 'center' 
        }).setOrigin(0.5);

        // THE "FIX": Global Window Listener
        // Instead of asking Phaser to restart, we destroy the whole game and start over.
        const hardReset = () => {
            window.removeEventListener('keydown', hardReset);
            window.removeEventListener('mousedown', hardReset);
            
            // Kill the current game instance
            game.destroy(true);
            
            // Wait one millisecond and create a brand new one
            setTimeout(() => {
                game = new Phaser.Game(gameConfig);
            }, 10);
        };

        window.addEventListener('keydown', hardReset);
        window.addEventListener('mousedown', hardReset);
    }

    function update() {
        if (isDead) return;

        player.setVelocity(0);
        if (cursors.left.isDown) player.setVelocityX(-300);
        else if (cursors.right.isDown) player.setVelocityX(300);
        if (cursors.up.isDown) player.setVelocityY(-300);
        else if (cursors.down.isDown) player.setVelocityY(300);

        skulls.getChildren().forEach(s => {
            this.physics.moveToObject(s, player, 150 + (score * 0.2));
        });
    }
    </script>
</body>
</html>
